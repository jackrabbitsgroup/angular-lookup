"use strict";angular.module("jackrabbitsgroup.angular-lookup",[]).directive("jrgLookup",["$filter","$timeout",function($filter,$timeout){function evalArray(arrayBase,params){var retArray={val:"",valid:1,msg:""};return void 0!==params.noDotNotation&&params.noDotNotation||(params.keys=params.keys.split(".")),1==params.keys.length?void 0!==arrayBase[params.keys[0]]&&(retArray.val=arrayBase[params.keys[0]]):2==params.keys.length?void 0!==arrayBase[params.keys[0]]&&(retArray.val=arrayBase[params.keys[0]][params.keys[1]]):3==params.keys.length?void 0!==arrayBase[params.keys[0]]&&void 0!==arrayBase[params.keys[0]][params.keys[1]]&&(retArray.val=arrayBase[params.keys[0]][params.keys[1]][params.keys[2]]):4==params.keys.length?void 0!==arrayBase[params.keys[0]]&&void 0!==arrayBase[params.keys[0]][params.keys[1]]&&void 0!==arrayBase[params.keys[0]][params.keys[1]][params.keys[2]]&&(retArray.val=arrayBase[params.keys[0]][params.keys[1]][params.keys[2]][params.keys[3]]):5==params.keys.length?void 0!==arrayBase[params.keys[0]]&&void 0!==arrayBase[params.keys[0]][params.keys[1]]&&void 0!==arrayBase[params.keys[0]][params.keys[1]][params.keys[2]]&&void 0!==arrayBase[params.keys[0]][params.keys[1]][params.keys[2]][params.keys[3]]&&(retArray.val=arrayBase[params.keys[0]][params.keys[1]][params.keys[2]][params.keys[3]][params.keys[4]]):6==params.keys.length?void 0!==arrayBase[params.keys[0]]&&void 0!==arrayBase[params.keys[0]][params.keys[1]]&&void 0!==arrayBase[params.keys[0]][params.keys[1]][params.keys[2]]&&void 0!==arrayBase[params.keys[0]][params.keys[1]][params.keys[2]][params.keys[3]]&&void 0!==arrayBase[params.keys[0]][params.keys[1]][params.keys[2]][params.keys[3]][params.keys[4]]&&(retArray.val=arrayBase[params.keys[0]][params.keys[1]][params.keys[2]][params.keys[3]][params.keys[4]][params.keys[5]]):(retArray.valid=0,retArray.msg="Too deep / too many keys; can only handle key length up to 6"),retArray}return{restrict:"A",transclude:!0,scope:{itemsRaw:"=",itemsFiltered:"=",filterFields:"=",loadMore:"&",opts:"="},replace:!0,template:function(element,attrs){var defaults={pageSize:10,placeholder:"search",scrollLoad:"0",loadMorePageSize:20,loadMoreItemsKey:"extra",filterFieldsDotNotation:!0,pageScroll:0,minSearchLength:2,minSearchShowAll:1,classInput:"",classInputCont:""};for(var xx in defaults)void 0===attrs[xx]&&(attrs[xx]=defaults[xx]);for(var attrsToInt=["pageSize","loadMorePageSize","scrollLoad","minSearchLength","minSearchShowAll"],ii=0;ii<attrsToInt.length;ii++)attrs[attrsToInt[ii]]=parseInt(attrs[attrsToInt[ii]],10);attrs.loadMorePageSize<attrs.pageSize&&(attrs.loadMorePageSize=attrs.pageSize),void 0===attrs.id&&(attrs.id="jrgLookup"+Math.random().toString(36).substring(7));var id1=attrs.id;attrs.ids={input:id1+"Input",contentBottom:id1+"ContentBottom",inputBelow:id1+"InputBelow",scrollContent:id1+"ScrollContent"};var html="<div class='jrg-lookup'><div class='jrg-lookup-top'><div class='jrg-lookup-input-div "+attrs.classInputCont+"'><input type='text' ng-change='changeInput({})' placeholder='"+attrs.placeholder+"' class='jrg-lookup-input "+attrs.classInput+"' ng-model='opts.searchText' ng-click='clickInput({})' /><div class='jrg-lookup-input-x' ng-click='clearInput({})'>X</div></div><div class='text-warning' ng-show='!trigs.loading && itemsFiltered.length <1 && opts.searchText.length >=minSearchLength'>No matches</div></div><div id='"+attrs.ids.scrollContent+"' class='jrg-lookup-content' ng-transclude></div><div id='"+attrs.ids.contentBottom+"'><div ng-hide='trigs.loading || (noMoreLoadMoreItems && queuedItems.length <1) || (scrollLoad && hasScrollbar)' class='jrg-lookup-more btn-link' ng-click='loadMoreDir({})'>Load More</div><div class='text-warning' ng-show='trigs.loading && opts.searchText.length >=minSearchLength'>Loading..</div><div ng-show='!trigs.loading && noMoreLoadMoreItems && queuedItems.length <1 && opts.searchText.length >=minSearchLength' class='jrg-lookup-no-more muted'>No More Results!</div></div></div>";return html},controller:function($scope,$element,$attrs){function init(){formItems({}),$scope.queuedItems.length<$attrs.pageSize&&$scope.totFilteredItems<$scope.page*$attrs.pageSize&&$scope.loadMoreDir({})}function resetItems(){$scope.page=1,checkForScrollBar({}),$scope.noMoreLoadMoreItems=!1,$scope.queuedItems=[],cursors={},cursors[$attrs.loadMoreItemsKey]=0,$scope.itemsRaw[$attrs.loadMoreItemsKey].items=[],document.getElementById($attrs.ids.scrollContent).scrollTop=0}function formItems(params){var keys;if(void 0!==params.keys)keys=params.keys;else{keys=[];var counter=0;for(var xx in $scope.itemsRaw)keys[counter]=xx,counter++}$scope.items=[];for(var ii=0;ii<keys.length;ii++)$scope.items=$scope.items.concat($scope.itemsRaw[keys[ii]].items);$scope.filterItems({})}function getMoreItems(){if(void 0!==$scope.loadMore&&void 0!==$scope.loadMore()&&"function"==typeof $scope.loadMore()){var retQueue=addItemsFromQueue({}),ppTemp={};if(retQueue.pageFilled||(ppTemp.partialLoad=!0,ppTemp.numToFillCurPage=$attrs.pageSize-retQueue.numItemsAdded,$scope.page*$attrs.pageSize>$scope.totFilteredItems&&$scope.totFilteredItems>($scope.page-1)*$attrs.pageSize&&(ppTemp.numToFillCurPage-=$scope.page*$attrs.pageSize-$scope.totFilteredItems)),$scope.queuedItems.length<$attrs.pageSize&&!$scope.noMoreLoadMoreItems){var loadPageSize=$attrs.loadMorePageSize;ppTemp.partialLoad&&loadPageSize<$attrs.pageSize+ppTemp.numToFillCurPage&&(loadPageSize=$attrs.pageSize+ppTemp.numToFillCurPage,ppTemp.loadPageSize=loadPageSize),$scope.loadMore()({cursor:cursors[$attrs.loadMoreItemsKey],loadMorePageSize:loadPageSize,searchText:$scope.opts.searchText},function(results,ppCustom){addLoadMoreItems(results,ppCustom,ppTemp)})}}else $scope.noMoreLoadMoreItems=!0,$scope.trigs.loading=!1}function addItemsFromQueue(params){var numFromQueue,retArray={pageFilled:!1,numItemsAdded:0};return $scope.queuedItems.length>0&&(params.numToAdd?(numFromQueue=params.numToAdd,$scope.queuedItems.length<numFromQueue&&(numFromQueue=$scope.queuedItems.length)):$scope.queuedItems.length>=$attrs.pageSize?(numFromQueue=$attrs.pageSize,retArray.pageFilled=!0):numFromQueue=$scope.queuedItems.length,retArray.numItemsAdded=numFromQueue,$scope.trigs.skipWatch=!0,$scope.itemsRaw[$attrs.loadMoreItemsKey].items=$scope.itemsRaw[$attrs.loadMoreItemsKey].items.concat($scope.queuedItems.slice(0,numFromQueue)),$timeout(function(){$scope.trigs.skipWatch=!1},250),void 0!==params.partialLoad&&params.partialLoad&&numFromQueue!=$attrs.pageSize||$scope.page++,formItems({}),$scope.queuedItems=$scope.queuedItems.slice(numFromQueue,$scope.queuedItems.length)),retArray}function addLoadMoreItems(results,ppCustom,params){if($scope.queuedItems=$scope.queuedItems.concat(results),cursors[$attrs.loadMoreItemsKey]+=results.length,(results.length<$attrs.loadMorePageSize||void 0!==params.loadPageSize&&results.length<params.loadPageSize)&&($scope.noMoreLoadMoreItems=!0),params.partialLoad){addItemsFromQueue({partialLoad:!0,numToAdd:params.numToFillCurPage})}$scope.trigs.loading=!1}function checkForScrollBar(){$scope.scrollLoad&&$timeout(function(){var scrollHeight;if($attrs.pageScroll){var viewportHeight;scrollHeight=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),viewportHeight=window.innerHeight,console.log(" scrollHeight: "+scrollHeight+" viewportHeight: "+viewportHeight),$scope.hasScrollbar=scrollHeight>viewportHeight?!0:!1}else{var ele=document.getElementById($attrs.ids.scrollContent);scrollHeight=ele.scrollHeight;var height1=ele.clientHeight;$scope.hasScrollbar=scrollHeight>height1?!0:!1}},100)}var defaults={};for(var xx in defaults)void 0===$scope[xx]&&($scope[xx]=defaults[xx]);void 0===$scope.opts&&($scope.opts={});var defaultOpts={searchText:"",watchItemKeys:["main"]};$scope.opts=angular.extend(defaultOpts,$scope.opts),$scope.minSearchLength=$attrs.minSearchLength,$scope.trigs={loading:!1,skipWatch:!1},$scope.items=[],$scope.page=1,$scope.totFilteredItems=0,$scope.queuedItems=[];var cursors={};if(cursors[$attrs.loadMoreItemsKey]=0,void 0===$scope.itemsRaw[$attrs.loadMoreItemsKey]&&($scope.itemsRaw[$attrs.loadMoreItemsKey]={items:[]}),$scope.itemsRaw[$attrs.loadMoreItemsKey].items=[],$scope.noMoreLoadMoreItems=!1,$scope.scrollLoad=$attrs.scrollLoad,$scope.scrollLoad){if(!$attrs.pageScroll){var ele1=document.getElementById($attrs.ids.scrollContent),eleAng=angular.element(ele1),height1=eleAng.css("height"),overflow1=eleAng.css("overflow");height1&&overflow1||eleAng.addClass("jrg-lookup-content-scroll")}$scope.hasScrollbar=!1}$scope.testFxn=function(){alert("test")};var timeoutInfo={search:{trig:!1,delay:750},scrolling:{trig:!1,delay:750}};$attrs.scrollLoad&&($attrs.pageScroll?window.onscroll=function(){$timeout.cancel(timeoutInfo.scrolling.trig),timeoutInfo.scrolling.trig=$timeout(function(){var scrollPos,scrollHeight,viewportHeight,buffer=25;scrollPos=window.pageYOffset||document.documentElement.scrollTop,scrollHeight=Math.max(document.body.scrollHeight,document.body.offsetHeight,document.documentElement.clientHeight,document.documentElement.scrollHeight,document.documentElement.offsetHeight),viewportHeight=window.innerHeight,console.log("scrollPos: "+scrollPos+" scrollHeight: "+scrollHeight+" viewportHeight: "+viewportHeight),scrollPos>=scrollHeight-viewportHeight-buffer&&$scope.loadMoreDir({noDelay:!0,next:!0}),buffer>=scrollPos&&$scope.loadMoreDir({noDelay:!0,prev:!0})},timeoutInfo.scrolling.delay)}:document.getElementById($attrs.ids.scrollContent).onscroll=function(){$timeout.cancel(timeoutInfo.scrolling.trig),$timeout.cancel(timeoutInfo.search.trig),timeoutInfo.scrolling.trig=$timeout(function(){var buffer=25,ele=document.getElementById($attrs.ids.scrollContent),scrollPos=ele.scrollTop,scrollHeight=ele.scrollHeight,height1=ele.clientHeight;scrollPos>=scrollHeight-height1-buffer&&$scope.loadMoreDir({noDelay:!0})},timeoutInfo.scrolling.delay)}),$scope.filterItems=function(){var searchText1=$scope.opts.searchText.toLowerCase();searchText1.length<$attrs.minSearchLength?$attrs.minSearchShowAll?$scope.itemsFiltered=$scope.items:($scope.itemsFiltered=[],resetItems({}),$scope.noMoreLoadMoreItems=!0):$scope.itemsFiltered=$filter("filter")($scope.items,function(item){for(var curItem,match=!1,ii=0;ii<$scope.filterFields.length;ii++){if($attrs.filterFieldsDotNotation&&$scope.filterFields[ii].indexOf(".")>-1){var retArray1=evalArray(item,{keys:$scope.filterFields[ii]});curItem=void 0!==retArray1.val?retArray1.val:!1}else curItem=void 0!==item[$scope.filterFields[ii]]?item[$scope.filterFields[ii]]:!1;if(curItem&&(curItem=curItem.toLowerCase(),curItem.indexOf(searchText1)>-1)){match=!0;break}}return match}),$scope.totFilteredItems=$scope.itemsFiltered.length,$scope.itemsFiltered=$scope.itemsFiltered.slice(0,$scope.page*$attrs.pageSize),checkForScrollBar({})},$scope.clickInput=function(){$scope.filterItems({})},$scope.clearInput=function(){$scope.opts.searchText="",$scope.changeInput({})},$scope.changeInput=function(){resetItems({}),formItems({}),timeoutInfo.search.trig&&$timeout.cancel(timeoutInfo.search.trig),$scope.totFilteredItems<$scope.page*$attrs.pageSize&&($scope.trigs.loading=!0,timeoutInfo.search.trig=$timeout(function(){getMoreItems({})},timeoutInfo.search.delay))};for(var ii=0;ii<$scope.opts.watchItemKeys.length;ii++)xx=$scope.opts.watchItemKeys[ii],$scope.$watch("itemsRaw."+xx+".items",function(newVal,oldVal){$scope.trigs.skipWatch||angular.equals(oldVal,newVal)||($scope.totFilteredItems<$scope.page*$attrs.pageSize&&resetItems({}),formItems({}))});$scope.$watch("opts.searchText",function(newVal,oldVal){angular.equals(oldVal,newVal)||$scope.changeInput({})}),$scope.$on("jrgLookupReformItems",function(){formItems({})}),$scope.$on("jrgLookupReInit",function(){resetItems({}),init({})}),$scope.loadMoreDir=function(params){var getMoreItemsTrig=!1;$scope.totFilteredItems>$scope.page*$attrs.pageSize?($scope.totFilteredItems<($scope.page+2)*$attrs.pageSize&&(getMoreItemsTrig=!0),$scope.page++,$scope.filterItems({})):getMoreItemsTrig=!0,params.noDelay=!0,getMoreItemsTrig&&(params.noDelay?getMoreItems({}):($scope.trigs.loading=!0,timeoutInfo.search.trig=$timeout(function(){getMoreItems({})},timeoutInfo.search.delay)))},init({})}}}]);